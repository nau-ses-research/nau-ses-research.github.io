---
title: "Faculty Publications"
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 12, fig.height = 7)

# Load required libraries
library(dplyr)
library(ggplot2)
library(plotly)
library(DT)
library(stringr)
library(lubridate)
library(tidyr)

# Load the statistics
if(file.exists("../website_stats.rds")) {
  stats <- readRDS("../website_stats.rds")
} else {
  source("../R/generate_website_stats.R")
  stats <- readRDS("../website_stats.rds")
}

faculty_data <- stats$faculty_pubs

# Load faculty data with StartYear and EndYear for productivity calculations
faculty_info <- read.csv("../facultygooglescholarids.csv") %>%
  rename(FirstInitial = `First.Initial`, LastName = `Last.Name`) %>%
  mutate(
    FullName = paste(FirstInitial, LastName),
    EndYear = ifelse(is.na(EndYear), lubridate::year(Sys.Date()), EndYear),
    Years_Active = EndYear - StartYear + 1
  )
```

# Faculty Publications Dashboard

The SES faculty have published **`r format(nrow(faculty_data), big.mark = ",")`** peer-reviewed articles since 2009, accumulating **`r format(sum(faculty_data$Citations, na.rm = TRUE), big.mark = ",")`** citations with a collective H-index of **`r stats$h_index`**.

---

## Publications Through Time

```{r publications-by-year}
# Publications by year
yearly_pubs <- faculty_data %>%
  filter(Year >= 2009) %>%
  group_by(Year) %>%
  summarise(
    Publications = n(),
    Citations = sum(Citations, na.rm = TRUE),
    .groups = 'drop'
  )

p1 <- ggplot(yearly_pubs, aes(x = Year, y = Publications)) +
  geom_col(fill = "#1f77b4", alpha = 0.8) +
  labs(
    title = "Faculty Publications by Year",
    subtitle = "Annual publication counts",
    x = "Year",
    y = "Number of Publications"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.text = element_text(size = 11),
    axis.title = element_text(size = 12, face = "bold")
  )

ggplotly(p1, tooltip = c("x", "y")) %>%
  layout(
    xaxis = list(fixedrange = FALSE),
    yaxis = list(fixedrange = FALSE)
  ) %>%
  config(displayModeBar = TRUE, displaylogo = FALSE)
```

---

## Citations Through Time

```{r citations-by-year}
p2 <- ggplot(yearly_pubs, aes(x = Year, y = Citations)) +
  geom_col(fill = "#2ca02c", alpha = 0.8) +
  labs(
    title = "Faculty Citations by Year",
    subtitle = "Annual citation counts",
    x = "Year",
    y = "Total Citations"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.text = element_text(size = 11),
    axis.title = element_text(size = 12, face = "bold")
  )

ggplotly(p2, tooltip = c("x", "y")) %>%
  layout(
    xaxis = list(fixedrange = FALSE),
    yaxis = list(fixedrange = FALSE)
  ) %>%
  config(displayModeBar = TRUE, displaylogo = FALSE)
```

---

## Faculty Productivity

```{r faculty-productivity}
# Publications per year by faculty member using StartYear/EndYear
faculty_productivity <- faculty_data %>%
  filter(SES_Faculty != "") %>%
  # Split faculty names and count
  mutate(faculty_list = strsplit(SES_Faculty, ", ")) %>%
  unnest(faculty_list) %>%
  group_by(faculty_list) %>%
  summarise(
    Publications = n(),
    Total_Citations = sum(Citations, na.rm = TRUE),
    Avg_Citations = round(mean(Citations, na.rm = TRUE), 1),
    .groups = 'drop'
  ) %>%
  # Join with faculty info to get years active
  left_join(faculty_info, by = c("faculty_list" = "FullName")) %>%
  filter(!is.na(Years_Active), Years_Active > 0) %>%
  mutate(
    Publications_Per_Year = round(Publications / Years_Active, 2),
    Tooltip_Text = paste0(faculty_list, "\n",
                         "Publications: ", Publications, "\n",
                         "Years Active: ", Years_Active, "\n",
                         "Pubs/Year: ", Publications_Per_Year)
  ) %>%
  arrange(desc(Publications_Per_Year)) %>%
  top_n(15, Publications_Per_Year)  # Top 15 by publications per year

p3 <- ggplot(faculty_productivity, aes(x = reorder(faculty_list, Publications_Per_Year), 
                                      y = Publications_Per_Year,
                                      text = Tooltip_Text)) +
  geom_col(fill = "#9467bd", alpha = 0.8) +
  coord_flip() +
  labs(
    title = "Top 15 Faculty Members by Publications per Year",
    subtitle = "Annual publication rate based on StartYear/EndYear in database",
    x = "Faculty Member",
    y = "Publications per Year"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12, face = "bold")
  )

ggplotly(p3, tooltip = "text") %>%
  layout(
    xaxis = list(fixedrange = FALSE),
    yaxis = list(fixedrange = FALSE)
  ) %>%
  config(displayModeBar = TRUE, displaylogo = FALSE)
```

---

## Most Cited Publications by SES Faculty

```{r top-cited-student-pubs}
# Top cited publications with graduate student co-authors
top_cited_faculty <- faculty_data %>%
  filter(SES_Faculty != "", !is.na(Citations), Citations > 0) %>%
  arrange(desc(Citations)) %>%
  select(Title, Authors, Journal, Year, Citations, Faculty = SES_Faculty) %>%
  head(20)

# Found data - proceeding with table

if(nrow(top_cited_faculty) > 0) {
  # Clean up long titles and author lists and rename column
  top_cited_faculty_clean <- top_cited_faculty %>%
    mutate(
      Title = ifelse(is.na(Title), "Unknown Title", Title),
      Authors = ifelse(is.na(Authors), "Unknown Authors", Authors),
      Journal = ifelse(is.na(Journal), "Unknown Journal", Journal),
      Title = ifelse(nchar(Title) > 80, paste0(substr(Title, 1, 77), "..."), Title),
      Authors = ifelse(nchar(Authors) > 100, paste0(substr(Authors, 1, 97), "..."), Authors),
      Journal = ifelse(nchar(Journal) > 40, paste0(substr(Journal, 1, 37), "..."), Journal)
    ) 
  
  # Create a simple HTML table that will definitely work
  top_cited_faculty_clean %>%
    knitr::kable(
      format = "html",
      caption = "Top 20 Most Cited Publications by SES Faculty",
      col.names = c("Title", "Authors", "Journal", "Year", "Citations","Faculty"),
      align = c("l", "l", "l", "c", "r", "l"),
      escape = FALSE,
      table.attr = 'class="table table-striped table-hover" style="font-size: 12px; margin-left: auto; margin-right: auto;"'
    )
} else {
  cat("No citation data available for student publications.")
}
```

---

## Journal Distribution

```{r journal-distribution}
# Top journals
journal_counts <- faculty_data %>%
  filter(!is.na(Journal), Journal != "") %>%
  count(Journal, sort = TRUE) %>%
  top_n(15, n)

p4 <- ggplot(journal_counts, aes(x = reorder(Journal, n), y = n)) +
  geom_col(fill = "#ff7f0e", alpha = 0.8) +
  coord_flip() +
  labs(
    title = "Top 15 Journals for Faculty Publications",
    subtitle = "Number of publications per journal",
    x = "Journal",
    y = "Number of Publications"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12, face = "bold")
  )

ggplotly(p4, tooltip = c("x", "y")) %>%
  layout(
    xaxis = list(fixedrange = FALSE),
    yaxis = list(fixedrange = FALSE)
  ) %>%
  config(displayModeBar = TRUE, displaylogo = FALSE)
```

---

## Summary Statistics

::: {.grid}
::: {.g-col-3}
**Total Publications**  
`r format(nrow(faculty_data), big.mark = ",")`
:::

::: {.g-col-3}
**Total Citations**  
`r format(sum(faculty_data$Citations, na.rm = TRUE), big.mark = ",")`
:::

::: {.g-col-3}
**Department H-Index**  
`r stats$h_index`
:::

::: {.g-col-3}
**Actively Publishing Faculty**  
`r stats$actively_publishing_count`
:::
:::

---

*Data includes publications from `r min(faculty_data$Year)` to `r max(faculty_data$Year)`. Last updated: `r format(Sys.time(), "%B %d, %Y")`*